// Jenkins Pipeline: build, test, Dockerize, push to ECR, deploy with Terraform, Slack notify, rollback

pipeline {
  agent any
  environment {
    AWS_REGION = 'ap-south-1'
    ECR_REPO = 'cloud-devops-microservice'
    IMAGE_TAG = "${env.BUILD_NUMBER}"
    SLACK_WEBHOOK = credentials('slack_webhook_url') // Jenkins secret
    AWS_ACCOUNT_ID = '123456789012' // <-- Replace with your actual AWS Account ID (12 digits)
    TF_VAR_image_tag = IMAGE_TAG
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Install & Unit Test') {
      steps {
        dir('app') {
          sh 'npm install'
          sh 'npm test'
        }
      }
    }
    stage('Build Docker image') {
      steps {
        dir('app') {
          script {
            sh """
              aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
              docker build -t $ECR_REPO:$IMAGE_TAG .
              docker tag $ECR_REPO:$IMAGE_TAG $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG
            """
          }
        }
      }
    }
    stage('Push image to AWS ECR') {
      steps {
        dir('app') {
          sh "docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG"
        }
      }
    }
    stage('Deploy to ECS Fargate using Terraform') {
      steps {
        dir('terraform') {
          sh "terraform init -backend-config='region=$AWS_REGION'"
          sh "terraform apply -auto-approve -var='image_tag=${TF_VAR_image_tag}'"
        }
      }
    }
    stage('Post Deploy') {
      steps {
        script { currentBuild.result = 'SUCCESS' }
        sh """
          curl -X POST -H 'Content-type: application/json' --data '{"text":"Deployment succeeded: Build #${IMAGE_TAG}"}' $SLACK_WEBHOOK
        """
      }
    }
  }
  post {
    failure {
      sh './scripts/rollback.sh'
      sh """
        curl -X POST -H 'Content-type: application/json' --data '{"text":"Deployment FAILED: Build #${IMAGE_TAG} rolled back"}' $SLACK_WEBHOOK
      """
    }
    always { cleanWs() }
  }
}